# tests/docker-compose.tests.yml
# This file is configured for self-contained integration testing within a CI/CD environment.
# It sets up a minimal environment with Nether-bridge and two Minecraft servers.
services:
  nether-bridge:
    image: nether-bridge-test:local
    container_name: nether-bridge
    build:
      context: ../
      dockerfile: Dockerfile
    restart: "no"
    networks:
      - mc-network
    ports:
      - "19132:19132/udp" # Default MCBE port players connect to first
      - "25565:25565/udp" # Port for Java server discovery
      - "25565:25565/tcp" # Port for Java server gameplay
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - LOG_LEVEL=DEBUG
      - NB_IDLE_TIMEOUT=30
      - NB_PLAYER_CHECK_INTERVAL=5
      - NB_QUERY_TIMEOUT=2
      - NB_SERVER_READY_MAX_WAIT=30
      - NB_INITIAL_BOOT_READY_MAX_WAIT=45
      - NB_SERVER_STARTUP_DELAY=2
      - NB_INITIAL_SERVER_QUERY_DELAY=2
      - NB_HEALTHCHECK_STALE_THRESHOLD=10
      - NB_HEARTBEAT_INTERVAL=5
      - NB_1_NAME=Bedrock Survival
      - NB_1_SERVER_TYPE=bedrock
      - NB_1_LISTEN_PORT=19132
      - NB_1_CONTAINER_NAME=mc-bedrock
      - NB_1_INTERNAL_PORT=19132
      - NB_2_NAME=Java Creative
      - NB_2_SERVER_TYPE=java
      - NB_2_LISTEN_PORT=25565
      - NB_2_CONTAINER_NAME=mc-java
      - NB_2_INTERNAL_PORT=25565
    healthcheck:
      test: ["CMD", "python", "nether_bridge.py", "--healthcheck"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  mc-bedrock:
    image: itzg/minecraft-bedrock-server:latest
    container_name: mc-bedrock
    restart: "no"
    networks:
      - mc-network
    # volumes:
    # Mount a local directory to /data in the container
    #  - ./data/mc-bedrock:/data
    environment:
      - EULA=TRUE
      - VERSION=1.21.84.1
      - IDLE_TIMEOUT=-1
    #  - DIRECT_DOWNLOAD_URL=https://www.minecraft.net/bedrockdedicatedserver/bin-linux/bedrock-server-1.21.84.1.zip
    # Removed explicit healthcheck, relying on container running state for now.

  mc-java:
    image: itzg/minecraft-server:latest
    container_name: mc-java
    restart: "no"
    networks:
      - mc-network
    # volumes:
    # Mount a local directory to /data in the container
    #  - ./data/mc-java:/data
    environment:
      - EULA=TRUE
      # Use Fabric for the fastest startup in tests
      - TYPE=FABRIC
      # Use a much older, faster-starting version
      - MINECRAFT_VERSION=1.16.5
      - JVM_ARGS=-Xmx512M -Xms512M
      - IDLE_TIMEOUT=-1
      # Disable online mode to prevent network delays on startup
      - ONLINE_MODE=FALSE
    # healthcheck: # <--- REMOVED: Healthcheck for mc-java
    #   test: ["CMD", "mcstatus", "java", "127.0.0.1:25565", "status"]
    #   interval: 5s
    #   timeout: 3s
    #   retries: 5
    #   start_period: 45s

networks:
  mc-network:
    driver: bridge

# Define named volumes if you decide to switch back to them later,
# but for local manual placement, direct bind mounts are simpler.
# volumes:
#   mc-bedrock-data:
#   mc-java-data: